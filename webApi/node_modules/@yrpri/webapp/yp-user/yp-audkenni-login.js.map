{"version":3,"file":"yp-audkenni-login.js","sourceRoot":"","sources":["../../src/yp-user/yp-audkenni-login.ts"],"names":[],"mappings":"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","sourcesContent":["import { html, css, nothing } from 'lit';\nimport { customElement, property } from 'lit/decorators.js';\nimport { YpBaseElement } from '../common/yp-base-element.js';\n\nimport '@material/web/textfield/outlined-text-field.js';\nimport '@material/web/button/filled-button.js';\nimport '@material/web/progress/circular-progress.js';\nimport '@material/web/radio/radio.js';\n\n@customElement('yp-audkenni-login')\nexport class YpAudkenniLogin extends YpBaseElement {\n  @property({ type: String })\n  phone = '';\n\n  @property({ type: String })\n  authenticator: 'sim' | 'card' = 'sim';\n\n  @property({ type: Boolean })\n  polling = false;\n\n  @property({ type: String })\n  pollId: string | undefined;\n\n  static override get styles() {\n    return [\n      super.styles,\n      css`\n        .loginField {\n          margin-bottom: 8px;\n          width: 100%;\n        }\n        .options {\n          margin-bottom: 8px;\n        }\n        .status {\n          margin-top: 8px;\n        }\n      `,\n    ];\n  }\n\n  override render() {\n    return html`\n      <div>\n        <md-outlined-text-field\n          class=\"loginField\"\n          .value=${this.phone}\n          @input=${(e: Event) =>\n            (this.phone = (e.target as HTMLInputElement).value)}\n          label=\"${this.t('user.phoneNumber') || 'Phone number'}\"\n        ></md-outlined-text-field>\n\n        <div class=\"options layout horizontal center-center\">\n          <label class=\"layout horizontal center-center\">\n            <md-radio\n              name=\"auth\"\n              value=\"sim\"\n              ?checked=${this.authenticator === 'sim'}\n              @change=${() => (this.authenticator = 'sim')}\n            ></md-radio>\n            <span>SIM</span>\n          </label>\n          <label class=\"layout horizontal center-center\">\n            <md-radio\n              name=\"auth\"\n              value=\"card\"\n              ?checked=${this.authenticator === 'card'}\n              @change=${() => (this.authenticator = 'card')}\n            ></md-radio>\n            <span>Card</span>\n          </label>\n        </div>\n\n        <md-filled-button\n          @click=${this.startLogin}\n          ?disabled=${this.polling}\n          >${this.t('login') || 'Login'}</md-filled-button\n        >\n\n        <div class=\"status\" ?hidden=${!this.polling}>\n          <md-circular-progress indeterminate></md-circular-progress>\n          <span>${this.t('user.waitingForConfirmation') || 'Waiting for confirmation...'}</span>\n        </div>\n      </div>\n    `;\n  }\n\n  async startLogin() {\n    if (!this.phone) {\n      this.fire('yp-error', this.t('user.completeForm'));\n      return;\n    }\n    this.polling = true;\n    const response = await fetch('/api/users/auth/audkenni-rest/start', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ phone: this.phone, authenticator: this.authenticator }),\n    });\n    if (response.ok) {\n      const data = await response.json();\n      this.pollId = data.id || data.pollId;\n      this._poll();\n    } else {\n      this.polling = false;\n      this.fire('yp-error', this.t('user.loginNotAuthorized'));\n    }\n  }\n\n  async _poll() {\n    if (!this.pollId) {\n      this.polling = false;\n      return;\n    }\n    const response = await fetch(\n      `/api/users/auth/audkenni-rest/poll/${this.pollId}`\n    );\n    if (response.ok) {\n      const data = await response.json();\n      if (data.pending) {\n        setTimeout(() => this._poll(), 2000);\n      } else if (data.user) {\n        this.polling = false;\n        this.dispatchEvent(\n          new CustomEvent('login-completed', {\n            detail: data.user,\n            bubbles: true,\n            composed: true,\n          })\n        );\n      } else {\n        setTimeout(() => this._poll(), 2000);\n      }\n    } else {\n      this.polling = false;\n    }\n  }\n}\n"]}