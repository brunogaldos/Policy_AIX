"use strict";const n=require("./defaults.cjs"),c=require("./collector.cjs"),o=require("../util/logger.cjs"),g=require("../config/index.cjs");class d extends c{constructor(t){super(),this.config={fontNames:n.fontNames,devicePlatforms:n.devicePlatforms,displayProps:n.displayProps,browserProps:n.browserProps,hardwareProps:n.hardwareProps,platformProps:n.platformProps},t&&Object.keys(t).forEach(e=>{if(!n.configurableCategories.includes(e))throw new Error("Device profile configuration category does not exist.");this.config[e]=t[e]})}getBrowserMeta(){return typeof navigator>"u"?(o.FRLogger.warn("Cannot collect browser metadata. navigator is not defined."),{}):this.reduceToObject(this.config.browserProps,navigator)}getBrowserPluginsNames(){return typeof navigator<"u"&&navigator.plugins?this.reduceToString(Object.keys(navigator.plugins),navigator.plugins):(o.FRLogger.warn("Cannot collect browser plugin information. navigator.plugins is not defined."),"")}getDeviceName(){if(typeof navigator>"u")return o.FRLogger.warn("Cannot collect device name. navigator is not defined."),"";const t=navigator.userAgent,e=navigator.platform;switch(!0){case this.config.devicePlatforms.mac.includes(e):return"Mac (Browser)";case this.config.devicePlatforms.ios.includes(e):return`${e} (Browser)`;case this.config.devicePlatforms.windows.includes(e):return"Windows (Browser)";case(/Android/.test(e)||/Android/.test(t)):return"Android (Browser)";case(/CrOS/.test(t)||/Chromebook/.test(t)):return"Chrome OS (Browser)";case/Linux/.test(e):return"Linux (Browser)";default:return`${e||"Unknown"} (Browser)`}}getDisplayMeta(){return typeof screen>"u"?(o.FRLogger.warn("Cannot collect screen information. screen is not defined."),{}):this.reduceToObject(this.config.displayProps,screen)}getHardwareMeta(){return typeof navigator>"u"?(o.FRLogger.warn("Cannot collect OS metadata. Navigator is not defined."),{}):this.reduceToObject(this.config.hardwareProps,navigator)}getIdentifier(){const t=`${g.get().prefix}-DeviceID`;if(!(typeof globalThis.crypto<"u"&&globalThis.crypto.getRandomValues))return o.FRLogger.warn("Cannot generate profile ID. Crypto and/or getRandomValues is not supported."),"";if(!localStorage)return o.FRLogger.warn("Cannot store profile ID. localStorage is not supported."),"";let e=localStorage.getItem(t);return e||(e=globalThis.crypto.getRandomValues(new Uint32Array(3)).join("-"),localStorage.setItem(t,e)),e}getInstalledFonts(){if(typeof document>"u")return o.FRLogger.warn("Cannot collect font data. Global document object is undefined."),"";const t=document.createElement("canvas");if(!t)return o.FRLogger.warn("Cannot collect font data. Browser does not support canvas element"),"";const e=t.getContext&&t.getContext("2d");if(!e)return o.FRLogger.warn("Cannot collect font data. Browser does not support 2d canvas context"),"";const r="abcdefghi0123456789";e.font="72px Comic Sans";const s=e.measureText(r).width;return this.config.fontNames.reduce((a,i)=>(e.font=`72px ${i}, Comic Sans`,e.measureText(r).width!==s&&(a=`${a}${i};`),a),"")}async getLocationCoordinates(){return typeof navigator<"u"&&navigator.geolocation?new Promise(async t=>{navigator.geolocation.getCurrentPosition(e=>t({latitude:e.coords.latitude,longitude:e.coords.longitude}),e=>{o.FRLogger.warn("Cannot collect geolocation information. "+e.code+": "+e.message),t({})},{enableHighAccuracy:!0,timeout:n.delay,maximumAge:0})}):(o.FRLogger.warn("Cannot collect geolocation information. navigator.geolocation is not defined."),Promise.resolve({}))}getOSMeta(){return typeof navigator>"u"?(o.FRLogger.warn("Cannot collect OS metadata. navigator is not defined."),{}):this.reduceToObject(this.config.platformProps,navigator)}async getProfile({location:t,metadata:e}){const r={identifier:this.getIdentifier()};return e&&(r.metadata={hardware:{...this.getHardwareMeta(),display:this.getDisplayMeta()},browser:{...this.getBrowserMeta(),plugins:this.getBrowserPluginsNames()},platform:{...this.getOSMeta(),deviceName:this.getDeviceName(),fonts:this.getInstalledFonts(),timezone:this.getTimezoneOffset()}}),t&&(r.location=await this.getLocationCoordinates()),r}getTimezoneOffset(){try{return new Date().getTimezoneOffset()}catch{return o.FRLogger.warn("Cannot collect timezone information. getTimezoneOffset is not defined."),null}}}module.exports=d;
