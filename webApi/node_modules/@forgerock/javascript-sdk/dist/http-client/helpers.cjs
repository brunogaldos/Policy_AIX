"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const A=require("../util/url.cjs"),C=require("../util/logger.cjs");function I(e,t,n){const i=new Headers(e.headers);return t.AuthenticateToServiceConditionAdvice?i.set("X-Tree",t.AuthenticateToServiceConditionAdvice[0]):t.TransactionConditionAdvice&&i.set("X-TxID",t.TransactionConditionAdvice[0]),n&&n.idToken&&i.set("X-IdToken",n.idToken),i}function R(e,t,n){const i=new URL(e);if(t.TransactionConditionAdvice){const o=t.TransactionConditionAdvice[0];i.searchParams.append("_txid",o)}return n&&n.idToken&&i.searchParams.append("_idtoken",n.idToken),i.toString()}function y(e,t,n,i,o){const r=e.advices&&e.advices.AuthenticateToServiceConditionAdvice,a=e.advices&&e.advices.TransactionConditionAdvice;let d="",s="";r?(d=r.reduce((c,u)=>{const l=c&&` ${c}`;return c=`${u}${l}`,c},""),s="AuthenticateToServiceConditionAdvice"):a&&(d=a.reduce((c,u)=>{const l=c&&` ${c}`;return c=`${u}${l}`,c},""),s="TransactionConditionAdvice");const T="<Advices><AttributeValuePair>",f=`<Attribute name="${s}"/>`,S=`<Value>${d}</Value>`,m=`${T}${f}${S}</AttributeValuePair></Advices>`,p=A.getEndpointPath("authenticate",i,o),g={authIndexType:"composite_advice",authIndexValue:m};return{init:{method:"POST",credentials:"include",headers:new Headers({"Accept-API-Version":"resource=2.0, protocol=1.0"})},timeout:n,url:A.resolve(t,`${p}?${A.stringify(g)}`)}}function z(e){return(e.headers.get("Content-Type")||"").includes("html")&&e.url.includes("composite_advice")}function V(e){return(e.get("WWW-Authenticate")||"").includes("advices")}async function x(e){return!!(await e.clone().json()).advices}function v(e){const n=new URL(e).searchParams.get("authIndexValue")||"",i=new DOMParser,o=decodeURIComponent(n),a=i.parseFromString(o,"application/xml").querySelector("Value");return a?a.innerHTML:""}function h(e){const n=(e.split(",")||[]).find(o=>o.includes("advices"))||"";let i;try{const o=n.match(/"(\S+)"/),r=o?o[1]:"",a=atob(r);return i=JSON.parse(a),i}catch{C.FRLogger.error("Could not parse advices value from WWW-Authenticate header")}return{}}function $(e){return e.advices&&e.advices.AuthenticateToServiceConditionAdvice?Array.isArray(e.advices.AuthenticateToServiceConditionAdvice)&&e.advices.AuthenticateToServiceConditionAdvice.length>0:e.advices&&e.advices.TransactionConditionAdvice?Array.isArray(e.advices.TransactionConditionAdvice)&&e.advices.TransactionConditionAdvice.length>0:!1}async function b(e){return!!(await e.clone().json()).callbacks}function H(e,t){return typeof t=="function"?t(e):e.status===401}function O(e){const t={};return e.url.includes("AuthenticateToServiceConditionAdvice")?t.AuthenticateToServiceConditionAdvice=[v(e.url)]:t.TransactionConditionAdvice=[v(e.url)],{resource:"",actions:{},attributes:{},advices:t,ttl:0}}function P(e){const t=e.headers.get("WWW-Authenticate")||"",n=h(t);return{resource:"",actions:{},attributes:{},advices:n,ttl:0}}async function F(e){return await e.json()}exports.addAuthzInfoToHeaders=I;exports.addAuthzInfoToURL=R;exports.buildAuthzOptions=y;exports.examineForIGAuthz=z;exports.examineForIGAuthzHeader=V;exports.examineForRESTAuthz=x;exports.getAdvicesFromHeader=h;exports.hasAuthzAdvice=$;exports.isAuthzStep=b;exports.newTokenRequired=H;exports.normalizeIGJSONResponseToAdviceJSON=P;exports.normalizeIGRedirectResponseToAdviceJSON=O;exports.normalizeRESTJSON=F;
